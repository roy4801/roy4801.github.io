<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Smart Pointer 介紹/用法 | r0yblog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Overview unique_ptr move construct only   shared_ptr reference counting   weak_ptr weak references   boost:scoped_ptr only in one scope    Smart Pointer ?">
<meta property="og:type" content="article">
<meta property="og:title" content="Smart Pointer 介紹&#x2F;用法">
<meta property="og:url" content="http://blog.roy4801.tw/2020/06/04/c++/smart_pointer/index.html">
<meta property="og:site_name" content="r0yblog">
<meta property="og:description" content="Overview unique_ptr move construct only   shared_ptr reference counting   weak_ptr weak references   boost:scoped_ptr only in one scope    Smart Pointer ?">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/N2wwSKD.png">
<meta property="og:image" content="https://i.imgur.com/5hqJUVf.png">
<meta property="article:published_time" content="2020-06-04T11:23:16.000Z">
<meta property="article:modified_time" content="2020-06-04T19:31:06.195Z">
<meta property="article:author" content="roy4801">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="程式">
<meta property="article:tag" content="教學">
<meta property="article:tag" content="Smart Pointer">
<meta property="article:tag" content="智慧指標">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/N2wwSKD.png">
  
    <link rel="alternate" href="/atom.xml" title="r0yblog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-133698344-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜尋"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.roy4801.tw"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首頁</a>
        
          <a class="main-nav-link" href="/archives">歸檔</a>
        
          <a class="main-nav-link" href="/about">關於</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">r0yblog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">存放一些有關程式、生活、心得隨筆的網誌</a>
        </h2>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-c++/smart_pointer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/04/c++/smart_pointer/" class="article-date">
  <time datetime="2020-06-04T11:23:16.000Z" itemprop="datePublished">2020-06-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%B8%E7%BF%92%E7%B4%80%E9%8C%84/">學習紀錄</a>►<a class="article-category-link" href="/categories/%E5%AD%B8%E7%BF%92%E7%B4%80%E9%8C%84/C-C/">C/C++</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Smart Pointer 介紹/用法
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><ul>
<li><code>unique_ptr</code><ul>
<li>move construct only</li>
</ul>
</li>
<li><code>shared_ptr</code><ul>
<li>reference counting</li>
</ul>
</li>
<li><code>weak_ptr</code><ul>
<li>weak references</li>
</ul>
</li>
<li><code>boost:scoped_ptr</code><ul>
<li>only in one scope</li>
</ul>
</li>
</ul>
<h2 id="Smart-Pointer"><a href="#Smart-Pointer" class="headerlink" title="Smart Pointer ?"></a>Smart Pointer ?</h2><p>在 C/C++ 中，最令人頭痛的事情是：「管理記憶體」，必須自己手動管理物件的生命週期，如果忘記 <code>delete</code> 或是拋出了 exception ，會造成記憶體洩漏(Memory Leak)；或是 <code>delete</code> 後，pointer 並沒有清空，後面的 code 又再度使用而導致 Use-After-Free 發生；或是一個 pointer 被重複 delete 了一次以上 (double free)。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> ptr = <span class="keyword">new</span> Foo();</span><br><span class="line"></span><br><span class="line">  func_throw_exception(); <span class="comment">// 丟出 exception, ptr 大爆死（不會 delete)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這些種種都會考驗到程式設計師的能力，更何況程式碼是由多人維護的，可能程式碼很長，指標指的 object 生命週期很長，但是在途中被 delete 了；又或者是兩個不同的 pointer 指向了同一塊 object ，那麼要由誰來 delete 呢（誰才擁有 ownership），如果誤刪了則可能導致程式崩潰或可能不會（undefinied behavior）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Foo* <span class="title">genFoo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Foo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Foo *a = genFoo();</span><br><span class="line"><span class="comment">// 誰來 delete 他？</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> a;</span><br><span class="line"></span><br><span class="line">freeFoo(a);</span><br></pre></td></tr></table></figure>
<p>於是有人便想到了使用 <code>class</code> 來將 pointer 封裝，古早年代曾有 <code>auto_ptr</code> 嘗試解決這個問題，但<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2005/n1856.html#20.4.5%20-%20Class%20template%20auto_ptr" target="_blank" rel="noopener">不是很成功</a>（在 <code>c++98</code> 被加入 <code>c++17</code> 時移除），在 C++11 中加入了 <code>unique_ptr</code>, <code>shared_ptr</code> 以及 <code>weak_ptr</code> 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 維護 ptr 是你的責任！</span></span><br><span class="line">T *ptr = <span class="keyword">new</span> T;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">delete</span> ptr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 概念上的 unique_ptr</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">unique_ptr</span> &#123;</span></span><br><span class="line">  T *p = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  ~<span class="built_in">unique_ptr</span>() &#123;</span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; <span class="title">a</span><span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>&#123;<span class="number">10</span>&#125;)</span></span>;</span><br><span class="line">&#125; <span class="comment">// 出了 scope 就被 delete 了</span></span><br></pre></td></tr></table></figure>
<p>上面的例子便可以改寫成：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">unique_ptr</span>&lt;Foo&gt; <span class="title">genFoo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">unique_ptr</span>&lt;Foo&gt;(<span class="keyword">new</span> Foo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此一來便不用擔心資源不被釋放了，因為 <code>unique_ptr</code> 出了 scope 便會釋放(RAII)</p>
<h2 id="unique-ptr-lt-T-gt"><a href="#unique-ptr-lt-T-gt" class="headerlink" title="unique_ptr&lt;T&gt;"></a><code>unique_ptr&lt;T&gt;</code></h2><ul>
<li><p>Use <code>std::unique_ptr</code> for exclusive-ownership resource management</p>
<ul>
<li>unique ownership<ul>
<li>一個資源只會被一個 object 所擁有</li>
</ul>
</li>
</ul>
</li>
<li><p><code>unique_ptr&lt;T&gt;</code> 不能複製(<code>operator=</code>)、不能 copy-construct</p>
</li>
<li><p><mark>只能被 move-construct</mark></p>
<ul>
<li>代表所有權(Ownership)的轉移</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; <span class="title">a</span><span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>&#123;<span class="number">10</span>&#125;)</span></span>;</span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; b = a; <span class="comment">// 這個會噴錯</span></span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; c;</span><br><span class="line">c = a; <span class="comment">// 這個也會噴錯</span></span><br></pre></td></tr></table></figure>
<p>標準庫</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_unique&lt;<span class="keyword">int</span>&gt;(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; b = <span class="built_in">std</span>::move(a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(a)</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"a is good"</span> &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line"><span class="keyword">if</span>(b)</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"b is good"</span> &lt;&lt; <span class="string">'\n'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b is good</span><br></pre></td></tr></table></figure>
<ul>
<li><code>unique_ptr&lt;T[]&gt;</code> unique_ptr 可以放 array types ，並且會被正確釋放 (呼叫 <code>delete []</code>)<ul>
<li><a href="https://wandbox.org/permlink/rsGPPlRrAgCbCgRn" target="_blank" rel="noopener">example</a></li>
</ul>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line">  Foo() &#123; <span class="built_in">puts</span>(<span class="string">"ctor()"</span>); &#125;</span><br><span class="line">  ~Foo() &#123; <span class="built_in">puts</span>(<span class="string">"dtor()"</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line">unique_ptr&lt;Foo[]&gt; a(new Foo[3]);</span><br></pre></td></tr></table></figure>
<p><a href="https://en.cppreference.com/w/cpp/memory/unique_ptr" target="_blank" rel="noopener"><img src="https://i.imgur.com/N2wwSKD.png" alt=""></a></p>
<ul>
<li>甚至可以自訂 <code>deleter</code> （如何刪除 pointer）<ul>
<li><a href="https://wandbox.org/permlink/mUh2rUpusxnj68eX" target="_blank" rel="noopener">example1</a>, <a href="https://wandbox.org/permlink/l34Y9VvYRBNXkk0r" target="_blank" rel="noopener">example2</a>, <a href="https://wandbox.org/permlink/zKWK75zrO8rRyb02" target="_blank" rel="noopener">example3</a></li>
<li>預設是 <code>std::default_delete&lt;T&gt;</code><ul>
<li>就是個 function object 裡頭 call <code>operator delete()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unique_ptr&lt;Foo, std::function&lt;void(Foo*)&gt;&gt; p(new Foo, [](Foo *p) &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"custom deleter"</span>);</span><br><span class="line">  <span class="keyword">delete</span> p;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 C++11 alias template，可以不用指定 delete 的 type<ul>
<li><a href="https://wandbox.org/permlink/0mrFvcBWJvwMcGMW" target="_blank" rel="noopener">example</a></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Widget</span> &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">using</span> uniquePtr = <span class="built_in">unique_ptr</span>&lt;T, <span class="keyword">void</span>(*)(T*)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function">uniquePtr&lt;Widget&gt; <span class="title">ptr</span><span class="params">( <span class="keyword">new</span> Widget, []( Widget *p ) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"delete Widget!"</span> &lt;&lt; <span class="built_in">endl</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">delete</span> p;</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li>用起來就跟 raw pointer 沒兩樣<ul>
<li><a href="https://wandbox.org/permlink/1jDoZ3QAEHBjL59R" target="_blank" rel="noopener">example</a></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ue_ptr&lt;<span class="keyword">int</span>&gt; a = make_unique&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">*a = <span class="number">87</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// custom class</span></span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;Foo&gt; b = make_unique&lt;Foo&gt;(<span class="number">4801</span>);</span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; b-&gt;getId() &lt;&lt; <span class="string">'\n'</span>;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// array</span></span><br><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>[]&gt; c = make_unique&lt;<span class="keyword">int</span>[]&gt;(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">  c[i] = i;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>void reset (pointer p = pointer())</code> 重設<ul>
<li><a href="https://wandbox.org/permlink/WI6OZWzC1K4dvhu6" target="_blank" rel="noopener">example</a></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_unique&lt;<span class="keyword">int</span>&gt;(<span class="number">123</span>);</span><br><span class="line">a.reset(<span class="keyword">new</span> <span class="keyword">int</span>&#123;<span class="number">2</span>&#125;); <span class="comment">// destroy 123 and take the ownership of 2</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>pointer release()</code> 釋放所有權<ul>
<li>釋放 <code>unique_ptr</code> 所維護的指標的所有權(Ownership)<ul>
<li>回傳 pointer 並將 <code>unique_ptr</code> 內部的 <code>ptr = nullptr</code></li>
</ul>
</li>
<li><a href="https://wandbox.org/permlink/OlGqKGizZIpixNma" target="_blank" rel="noopener">Example</a></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_unique&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">*a = <span class="number">87</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *b = a.release();</span><br><span class="line"><span class="keyword">delete</span> b;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>pointer get()</code> 獲取 <code>unique_ptr</code> 底下的 raw pointer<ul>
<li><a href="https://wandbox.org/permlink/Bl2NINecJdxywbtr" target="_blank" rel="noopener">Example</a></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_unique&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">int</span> *p = a.get(); <span class="comment">// raw pointer</span></span><br></pre></td></tr></table></figure>
<h3 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h3><ul>
<li>unique-ownership<ul>
<li><code>unique_ptr</code> 是獨占資源的，如果用同個 raw pointer 來初始化多個 <code>unique_ptr</code> 會被 delete 數次</li>
<li>以下是錯誤的範例</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line">Foo *f = <span class="keyword">new</span> Foo();</span><br><span class="line"><span class="function"><span class="built_in">unique_ptr</span>&lt;Foo&gt; <span class="title">a</span><span class="params">(f)</span></span>;</span><br><span class="line"><span class="function"><span class="built_in">unique_ptr</span>&lt;Foo&gt; <span class="title">b</span><span class="params">(f)</span></span>;</span><br><span class="line"><span class="comment">// f 會被 delete 兩次，導致 undefinied behaviour</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>Exception 安全</p>
<ul>
<li><p>用 Raw pointer 創建 <code>unique_ptr</code> 不保證 exception 安全</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func(<span class="built_in">unique_ptr</span>&lt;Foo&gt;(<span class="keyword">new</span> Foo), func_throw_exception());</span><br></pre></td></tr></table></figure>
<ul>
<li>C++ 標準並沒有規定對參數的 evaluate 之順序<ul>
<li>所以可能出現這樣的順序：<ul>
<li><code>new Foo</code></li>
<li><code>func_throw_exception()</code></li>
<li><code>unique_ptr&lt;Foo&gt;(...)</code></li>
</ul>
</li>
<li>在 <code>func_throw_exception()</code> 時會拋出 exception，導致無法建構 <code>unique_ptr</code> ，造成 <code>new Foo</code> 無法回收，導致記憶體洩漏(Memory Leak)</li>
</ul>
</li>
</ul>
</li>
<li><p>使用 <code>make_unique&lt;T&gt;()</code> 則可以解決這個問題</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func(make_unique&lt;Foo&gt;(), func_throw_exception());</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>到了 c++14 才有 <code>make_unique&lt;T&gt;()</code> 這個 function，並沒有在以前的標準，但是自己實現並不複雜</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;T&gt; <span class="title">make_unique</span><span class="params">(Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;T&gt;( <span class="keyword">new</span> T(<span class="built_in">std</span>::forward&lt;Args&gt;(args)...) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="shared-ptr-lt-T-gt"><a href="#shared-ptr-lt-T-gt" class="headerlink" title="shared_ptr&lt;T&gt;"></a><code>shared_ptr&lt;T&gt;</code></h2><p>跟 <code>unique_ptr</code> 不同的是，<code>shared_ptr</code> 可以讓同個資源給多個 <code>shared_ptr</code> 「共用」，所以 <code>shared_ptr</code> <strong>可以複製</strong>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; b = a;</span><br></pre></td></tr></table></figure>
<p><a href="https://wandbox.org/permlink/uxTK0I8svtw77PmF" target="_blank" rel="noopener">Example1</a></p>
<p><code>shared_ptr</code> 內部實作 Reference Count ，每當有一個 <code>shared_ptr</code> 建立並指向同個資源時，Reference Count 變加一，當一個 <code>shared_ptr</code> 被 destruct 時，會把 Reference Count 減一。當最後一個指向資源的 <code>shared_ptr</code> 被 destruct 時，則會釋放資源。</p>
<p><img src="https://i.imgur.com/5hqJUVf.png" alt=""></p>
<blockquote>
<p>比喻：有一個房間有一盞燈（資源），房間裡有很多人（共享），約定好最後一個出去的關燈（釋放資源）</p>
</blockquote>
<p><strong>指向同個 object</strong> 之所有的 <code>shared_ptr</code> 共用一個 Control Block ，上頭有 Reference Count 以及其他 <code>shared_ptr</code> 會用到的東西</p>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><ul>
<li><p><code>shared_ptr</code> 的用法跟 <code>unique_ptr</code> 差不多</p>
</li>
<li><p><code>use_count()</code> 回傳 <code>shared_ptr</code> 的 reference count</p>
<ul>
<li><a href="https://wandbox.org/permlink/wewpZFc0UJLzTOVw" target="_blank" rel="noopener">Example</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_shared&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; b = a;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, b.use_count()); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>unique()</code> 是否唯一</p>
<ul>
<li><a href="https://wandbox.org/permlink/NZmY1rRH1mZhK9EG" target="_blank" rel="noopener">Example</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_shared&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; b = a;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, b.unique()); <span class="comment">// 0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, a.unique()); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>shared_ptr</code> 有提供轉型指標(cast)</p>
<ul>
<li><code>static_pointer_cast&lt;T&gt;(sp)</code><ul>
<li>相當於 <code>static_cast&lt;T*&gt;(sp.get())</code></li>
</ul>
</li>
<li><code>dynamic_pointer_cast&lt;T&gt;(sp)</code><ul>
<li>相當於 <code>dynamic_cast&lt;T*&gt;(sp.get())</code></li>
</ul>
</li>
<li><code>const_pointer_cast&lt;T&gt;(sp)</code><ul>
<li>相當於 <code>const_cast&lt;T*&gt;(sp.get())</code></li>
</ul>
</li>
<li><a href="https://wandbox.org/permlink/tzrMWn0p5Fxds4Bu" target="_blank" rel="noopener">Example</a></li>
</ul>
</li>
</ul>
<h3 id="一些坑-1"><a href="#一些坑-1" class="headerlink" title="一些坑"></a>一些坑</h3><p>但是事情並沒有那麼美好，<code>shared_ptr</code> 還是會有些坑</p>
<ul>
<li><p>用同個 raw pointer 重複初始化 <code>shared_ptr</code></p>
<ul>
<li>會導致重複釋放資源</li>
<li><a href="https://wandbox.org/permlink/FtJrudxmYldlNfa8" target="_blank" rel="noopener">Example</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Foo *f = <span class="keyword">new</span> Foo();</span><br><span class="line"><span class="function"><span class="built_in">shared_ptr</span>&lt;Foo&gt; <span class="title">a</span><span class="params">(f)</span></span>;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="built_in">shared_ptr</span>&lt;Foo&gt; <span class="title">b</span><span class="params">(f)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>結論：用 <code>make_shared&lt;&gt;()</code> 就好</li>
</ul>
</li>
<li><p><code>unique_ptr</code> 可以轉成 <code>shared_ptr</code> ，但是反過來不行</p>
</li>
<li><p><code>shared_ptr</code> 原生不支援陣列型態</p>
<ul>
<li>沒有 <code>operator[]</code></li>
<li>沒有特化的 deltetr，必須自己給</li>
</ul>
</li>
<li><p>循環參考 (Circular Reference)</p>
<ul>
<li><a href="https://wandbox.org/permlink/fTMsKxwRduSe7zCw" target="_blank" rel="noopener">Example</a></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span>&#123;</span></span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  <span class="built_in">shared_ptr</span>&lt;Foo&gt; next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;Foo&gt; a = make_shared&lt;Foo&gt;(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;Foo&gt; b = make_shared&lt;Foo&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">a-&gt;next = b;</span><br><span class="line">b-&gt;next = a;</span><br></pre></td></tr></table></figure>
<ul>
<li>猜猜上面的 code 到最後有誰會被釋放<ul>
<li>答案是 0 個</li>
</ul>
</li>
<li>因為循環參考(Circular Reference)的關係</li>
</ul>
</li>
</ul>
<h2 id="weak-ptr-lt-T-gt"><a href="#weak-ptr-lt-T-gt" class="headerlink" title="weak_ptr&lt;T&gt;"></a><code>weak_ptr&lt;T&gt;</code></h2><p><code>weak_ptr</code> 並不會增加 <code>shared_ptr</code> 的 reference count ，亦不會搶走所有權 (Ownership)</p>
<p>用於解決循環參考(Circular Reference)的問題，跟 <code>shared_ptr</code> 搭配使用<br>將上面的例子改寫成:</p>
<p><a href="https://wandbox.org/permlink/JSUEZg5sPUhAnhH2" target="_blank" rel="noopener">Example</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span>&#123;</span></span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">  weak_ptr&lt;Foo&gt; next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;Foo&gt; a = make_shared&lt;Foo&gt;(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">shared_ptr</span>&lt;Foo&gt; b = make_shared&lt;Foo&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">a-&gt;next = b;</span><br><span class="line">b-&gt;next = a;</span><br></pre></td></tr></table></figure>
<p>最後則會正常釋放</p>
<h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><ul>
<li><code>weak_ptr</code> 並不能直接存取(沒有 <code>operator-&gt;</code>)，如果要存取的話，必須使用 <code>.lock()</code> 轉成 <code>shared_ptr</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; a = make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line">&#123;</span><br><span class="line">  weak_ptr&lt;<span class="keyword">int</span>&gt; w = a;</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">auto</span> ws = w.lock();</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; *ws &lt;&lt; <span class="string">'\n'</span>; <span class="comment">// 10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>.expired()</code> 查看 <code>weak_ptr</code> 使否可用<ul>
<li><a href="https://wandbox.org/permlink/xKjQ9iOKoAqClBdW" target="_blank" rel="noopener">Example</a></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; <span class="title">shared</span> <span class="params">(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"><span class="built_in">std</span>::weak_ptr&lt;<span class="keyword">int</span>&gt; weak;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1. weak "</span> &lt;&lt; (weak.expired()?<span class="string">"is"</span>:<span class="string">"is not"</span>) &lt;&lt; <span class="string">" expired\n"</span>;</span><br><span class="line"><span class="comment">// 1. weak is expired</span></span><br><span class="line"></span><br><span class="line">weak = shared;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2. weak "</span> &lt;&lt; (weak.expired()?<span class="string">"is"</span>:<span class="string">"is not"</span>) &lt;&lt; <span class="string">" expired\n"</span>;</span><br><span class="line"><span class="comment">// 2. weak is not expired</span></span><br></pre></td></tr></table></figure>
<h2 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h2><ul>
<li><code>unique_ptr</code> 單獨擁有(Ownership)一個資源，如果要給別人要用 <code>std::move()</code></li>
<li><code>shared_ptr</code> 在需要多個人共同擁有一個資源時使用</li>
<li><code>weak_ptr</code> 在不想要給擁有權，但又想要它看的到並摸得到資源時</li>
</ul>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><p>Learncpp<br><a href="https://www.learncpp.com/" target="_blank" rel="noopener">https://www.learncpp.com/</a></p>
<p>Why is auto_ptr being deprecated?<br><a href="https://stackoverflow.com/questions/3697686/why-is-auto-ptr-being-deprecated" target="_blank" rel="noopener">https://stackoverflow.com/questions/3697686/why-is-auto-ptr-being-deprecated</a></p>
<p>CppCon 2019: Arthur O’Dwyer “Back to Basics: Smart Pointers”<br><a href="https://www.youtube.com/watch?v=xGDLkt-jBJ4" target="_blank" rel="noopener">https://www.youtube.com/watch?v=xGDLkt-jBJ4</a></p>
<p>深入 C++ 的 unique_ptr<br><a href="http://senlinzhan.github.io/2015/04/20/%E8%B0%88%E8%B0%88C-%E7%9A%84%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/" target="_blank" rel="noopener">http://senlinzhan.github.io/2015/04/20/%E8%B0%88%E8%B0%88C-%E7%9A%84%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/</a></p>
<p>How to implement make_unique function in C++11?<br><a href="https://stackoverflow.com/questions/17902405/how-to-implement-make-unique-function-in-c11" target="_blank" rel="noopener">https://stackoverflow.com/questions/17902405/how-to-implement-make-unique-function-in-c11</a></p>
<p>山姆大叔談 C++：從歷史談起，再給個定義—Modern C++ 解惑<br><a href="https://ithelp.ithome.com.tw/articles/10213866" target="_blank" rel="noopener">https://ithelp.ithome.com.tw/articles/10213866</a><br><a href="https://ithelp.ithome.com.tw/articles/10214337" target="_blank" rel="noopener">https://ithelp.ithome.com.tw/articles/10214337</a></p>
<p><a href="https://kheresy.wordpress.com/2012/03/05/c11_smartpointer_p2/" target="_blank" rel="noopener">https://kheresy.wordpress.com/2012/03/05/c11_smartpointer_p2/</a></p>
<p><a href="https://blog.jaycetyle.com/2019/11/passing-smart-pointer/" target="_blank" rel="noopener">https://blog.jaycetyle.com/2019/11/passing-smart-pointer/</a></p>

        
        <div>
          <hr>
          <p style="margin-bottom: 0;">如果你覺得這篇文章很棒，請你不吝點讚 (ﾟ∀ﾟ)</p>
          <iframe width="100%" height="230px" scrolling="no" frameborder="0" id="player" src="https://button.like.co/in/embed/a82611141/button/?referrer=http://blog.roy4801.tw/2020/06/04/c++/smart_pointer/" allowfullscreen="true"></iframe>
        </div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.roy4801.tw/2020/06/04/c++/smart_pointer/" data-id="ckb9mrh7i0045cytk8vov7b8i" class="article-share-link">分享</a>
      
      
        <a href="http://blog.roy4801.tw/2020/06/04/c++/smart_pointer/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Smart-Pointer/" rel="tag">Smart Pointer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%99%E5%AD%B8/" rel="tag">教學</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%99%BA%E6%85%A7%E6%8C%87%E6%A8%99/" rel="tag">智慧指標</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A8%8B%E5%BC%8F/" rel="tag">程式</a></li></ul>

    </footer>
  </div>
  
    
 
<script src="/jquery/jquery.min.js"></script>

  <div id="random_posts">
    <h2>推薦文章</h2>
    <div class="random_posts_ul">
      <script>
          var random_count =4
          var site = {BASE_URI:'/'};
          function load_random_posts(obj) {
              var arr=site.posts;
              if (!obj) return;
              // var count = $(obj).attr('data-count') || 6;
              for (var i, tmp, n = arr.length; n; i = Math.floor(Math.random() * n), tmp = arr[--n], arr[n] = arr[i], arr[i] = tmp);
              arr = arr.slice(0, random_count);
              var html = '<ul>';
            
              for(var j=0;j<arr.length;j++){
                var item=arr[j];
                html += '<li><strong>' + 
                item.date + ':&nbsp;&nbsp;<a href="' + (site.BASE_URI+item.uri) + '">' + 
                (item.title || item.uri) + '</a></strong>';
                if(item.excerpt){
                  html +='<div class="post-excerpt">'+item.excerpt+'</div>';
                }
                html +='</li>';
                
              }
              $(obj).html(html + '</ul>');
          }
          $('.random_posts_ul').each(function () {
              var c = this;
              if (!site.posts || !site.posts.length){
                  $.getJSON(site.BASE_URI + 'js/posts.js',function(json){site.posts = json;load_random_posts(c)});
              } 
               else{
                load_random_posts(c);
              }
          });
      </script>
    </div>
  </div>

    
<nav id="article-nav">
  
  
    <a href="/2020/05/18/tutorial/clion-gdb-debugging/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">使用 CLion + gdb Debug 程式</div>
    </a>
  
</nav>

  
</article>
 
     
  <div class="comments" id="comments">
    
     
    <section id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
      </section>
      
       
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
       
      
      
  </div>
 
  

</section>
           
    <aside id="sidebar">
  
    

  
    
    <div class="widget-wrap">
    
      <div class="widget" id="toc-widget-fixed">
      
        <strong class="toc-title">文章目錄</strong>
        <div class="toc-widget-list">
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Smart-Pointer"><span class="toc-number">2.</span> <span class="toc-text">Smart Pointer ?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unique-ptr-lt-T-gt"><span class="toc-number">3.</span> <span class="toc-text">unique_ptr&lt;T&gt;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-number">3.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些坑"><span class="toc-number">3.2.</span> <span class="toc-text">一些坑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shared-ptr-lt-T-gt"><span class="toc-number">4.</span> <span class="toc-text">shared_ptr&lt;T&gt;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-1"><span class="toc-number">4.1.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些坑-1"><span class="toc-number">4.2.</span> <span class="toc-text">一些坑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#weak-ptr-lt-T-gt"><span class="toc-number">5.</span> <span class="toc-text">weak_ptr&lt;T&gt;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-2"><span class="toc-number">5.1.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#結論"><span class="toc-number">6.</span> <span class="toc-text">結論</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#參考"><span class="toc-number">7.</span> <span class="toc-text">參考</span></a></li></ol>
          </div>
      </div>
    </div>

  
    

  
    
  
    

  
    
  
    
  
    

  
    
  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2018 - 2020 roy4801&nbsp;|&nbsp;
      Theme by <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      聯繫方式&nbsp;|&nbsp;YTgyNjExMTQxQGdtYWlsLmNvbQo=
    </div>
  </div>
</footer>
 
<script src="/jquery/jquery.min.js"></script>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首頁</a>
  
    <a href="/archives" class="mobile-nav-link">歸檔</a>
  
    <a href="/about" class="mobile-nav-link">關於</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

<script>
  var disqus_shortname = 'roy-blog';
  
  var disqus_url = 'http://blog.roy4801.tw/2020/06/04/c++/smart_pointer/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 
<script src="/js/is.js"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/elevator.js"></script>

  </div>
</body>
</html>